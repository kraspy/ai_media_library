{% extends "base.html" %}
{% load i18n %}

{% load markdown_extras %}

{% block main_class %}flex-grow-1 d-flex flex-column p-0 bg-dark text-light overflow-hidden{% endblock %}
{% block content %}
<div class="container-fluid flex-grow-1 d-flex flex-column py-2 py-md-4">
    <div class="row flex-grow-1">
        <!-- Sidebar: Chat History -->
        <div class="col-md-3 d-none d-md-flex flex-column border-end border-secondary pe-3">
             <div class="d-grid mb-3">
                <a href="{% url 'learning:tutor_create' %}" class="btn btn-info">
                    <i class="bi bi-plus-lg me-2"></i>{% trans "New Chat" %}
                </a>
            </div>
            <h6 class="text-secondary text-uppercase small ls-1 mb-3">{% trans "Recent Chats" %}</h6>
            <div class="list-group list-group-flush overflow-auto flex-grow-1 custom-scrollbar">
                {% for s in sessions %}
                <a href="{% url 'learning:tutor_session' s.id %}" class="list-group-item list-group-item-action border-0 rounded mb-1 text-truncate {% if s.id == session.id %}active bg-secondary-subtle text-light{% else %}bg-transparent text-secondary{% endif %}">
                    <i class="bi bi-chat-left-text me-2"></i> {{ s.title }}
                    <br><small class="opacity-50 ps-4">{{ s.updated_at|date:"M d, H:i" }}</small>
                </a>
                {% endfor %}
            </div>
        </div>

        <!-- Main Chat Area -->
        <div class="col-md-9 col-lg-9 d-flex flex-column ps-md-3">
            
            <!-- Header -->
            <div class="card card-custom bg-dark text-light mb-3 flex-shrink-0">
                <div class="card-body d-flex justify-content-between align-items-center py-2 px-3">
                    <div class="d-flex align-items-center text-truncate">
                        <!-- Mobile Toggle -->
                        <button class="btn btn-sm btn-outline-secondary d-md-none me-2" type="button" data-bs-toggle="offcanvas" data-bs-target="#chatSidebar" aria-controls="chatSidebar">
                             <i class="bi bi-list"></i>
                        </button>

                        <h5 class="mb-0 me-3 text-truncate">
                            <i class="bi bi-robot me-2 text-info"></i>{{ session.title }}
                        </h5>
                        <button class="btn btn-sm btn-outline-info" data-bs-toggle="modal" data-bs-target="#contextModal" title="{% trans 'Select Topic' %}">
                            <i class="bi bi-bookmarks-fill me-1"></i> <span id="current-context-label">{{ context_label|default:_("General Chat") }}</span>
                        </button>
                    </div>
                    <div>
                         <button class="btn btn-sm btn-outline-warning me-1" onclick="editTitle()" title="{% trans 'Edit Title' %}">
                            <i class="bi bi-pencil"></i>
                        </button>
                        <form method="post" action="{% url 'learning:tutor_delete' session.id %}" class="d-inline" onsubmit="return confirm('{% trans "Are you sure you want to delete this chat?" %}');">
                            {% csrf_token %}
                            <button type="submit" class="btn btn-sm btn-outline-danger me-1" title="{% trans 'Delete Chat' %}">
                                <i class="bi bi-trash"></i>
                            </button>
                        </form>
                        <button class="btn btn-sm btn-outline-secondary" onclick="location.reload()" title="{% trans 'Refresh Chat' %}">
                            <i class="bi bi-arrow-clockwise"></i>
                        </button>
                    </div>
                </div>
            </div>

            <!-- Hidden Input for Context -->
            <input type="hidden" id="context-type" value="{{ context_type|default:'' }}">
            <input type="hidden" id="context-id" value="{{ context_id|default:'' }}">

            <!-- Context Selection Modal -->
            <div class="modal fade" id="contextModal" tabindex="-1" aria-hidden="true">
                <div class="modal-dialog modal-dialog-centered">
                    <div class="modal-content bg-dark text-light border-secondary">
                        <div class="modal-header border-secondary">
                            <h5 class="modal-title">{% trans "Select Learning Context" %}</h5>
                            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <div class="modal-body">
                            <ul class="nav nav-tabs mb-3 border-secondary" id="contextTab" role="tablist">
                                <li class="nav-item" role="presentation">
                                    <button class="nav-link active text-light" data-bs-toggle="tab" data-bs-target="#plans-tab" type="button">{% trans "Study Plans" %}</button>
                                </li>
                                <li class="nav-item" role="presentation">
                                    <button class="nav-link text-light" data-bs-toggle="tab" data-bs-target="#concepts-tab" type="button">{% trans "Learning Contexts" %}</button>
                                </li>
                            </ul>
                            <div class="tab-content" id="contextTabContent">
                                <div class="tab-pane fade show active" id="plans-tab" role="tabpanel">
                                    <div class="list-group list-group-flush">
                                        <button type="button" class="list-group-item list-group-item-action bg-dark text-light border-secondary context-item" data-type="" data-id="" data-label="{% trans 'General Chat' %}">
                                            <i class="bi bi-chat-dots me-2"></i> {% trans "General Chat" %}
                                        </button>
                                        {% for plan in active_plans %}
                                        <button type="button" class="list-group-item list-group-item-action bg-dark text-light border-secondary context-item" data-type="plan" data-id="{{ plan.id }}" data-label="{{ plan.topic.title|default:plan.media_item.title }}">
                                            <i class="bi bi-journal-text me-2"></i> {{ plan.topic.title|default:plan.media_item.title }}
                                        </button>
                                        {% endfor %}
                                    </div>
                                </div>
                                <div class="tab-pane fade" id="concepts-tab" role="tabpanel">
                                    <div class="list-group list-group-flush" style="max-height: 300px; overflow-y: auto;">
                                        {% for concept in recent_concepts %}
                                        <button type="button" class="list-group-item list-group-item-action bg-dark text-light border-secondary context-item" data-type="concept" data-id="{{ concept.id }}" data-label="{{ concept.title }}">
                                            <i class="bi bi-lightbulb me-2"></i> {{ concept.title }}
                                        </button>
                                        {% empty %}
                                            <p class="text-muted p-2">{% trans "No concepts studied recently." %}</p>
                                        {% endfor %}
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>


            <!-- Chat Window -->
            <div class="card card-custom bg-dark text-light flex-grow-1 mb-3 position-relative" style="overflow: hidden;">
                <div class="card-body p-0 d-flex flex-column h-100">
                    <div id="chat-messages" class="flex-grow-1 p-3" style="overflow-y: auto;">
                        {% for msg in chat_messages %}
                            <div class="d-flex mb-3 {% if msg.role == 'user' %}justify-content-end{% else %}justify-content-start{% endif %}">
                                <div class="p-3 rounded-3 {% if msg.role == 'user' %}bg-primary text-white{% else %}bg-secondary text-light{% endif %}" style="max-width: 80%;">
                                    <div class="mb-1 small opacity-75">
                                        {% if msg.role == 'user' %}{% trans "You" %}{% else %}{% trans "Tutor" %}{% endif %}
                                    </div>
                                    <div class="message-content markdown-body">
                                        {% if msg.role == 'assistant' %}{{ msg.content|markdown|safe }}{% else %}{{ msg.content|strip }}{% endif %}
                                    </div>
                                </div>
                            </div>
                        {% empty %}
                            <div class="text-center text-muted mt-5" id="empty-state">
                                <i class="bi bi-chat-dots display-4 mb-3"></i>
                                <p>{% trans "Start a conversation with your AI Tutor!" %}</p>
                            </div>
                        {% endfor %}
                    </div>
                </div>
                
                 <!-- Loading Indicator -->
                <div id="loading" class="position-absolute bottom-0 start-50 translate-middle-x mb-3 d-none">
                     <span class="badge bg-dark border border-secondary p-2 shadow">
                        <span class="spinner-grow spinner-grow-sm text-info me-1" role="status" aria-hidden="true"></span>
                        {% trans "Tutor is thinking..." %}
                     </span>
                </div>
            </div>

            <!-- Input Area -->
            <div class="card card-custom bg-dark text-light flex-shrink-0">
                <div class="card-body p-2">
                    <form id="chat-form" class="d-flex gap-2">
                        <textarea id="message-input" class="form-control bg-dark-subtle text-light border-secondary" rows="1" placeholder="{% trans 'Ask a question...' %}" style="resize: none; text-align: left; overflow: hidden;" required></textarea>
                        <button type="submit" class="btn btn-info align-self-end">
                            <i class="bi bi-send-fill"></i>
                        </button>
                    </form>
                </div>
            </div>

        </div>
    </div>
</div>

<!-- Mobile Offcanvas Sidebar -->
<div class="offcanvas offcanvas-start bg-dark text-light" tabindex="-1" id="chatSidebar" aria-labelledby="chatSidebarLabel">
  <div class="offcanvas-header border-bottom border-secondary">
    <h5 class="offcanvas-title" id="chatSidebarLabel">{% trans "Chat History" %}</h5>
    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="offcanvas" aria-label="Close"></button>
  </div>
  <div class="offcanvas-body d-flex flex-column">
      <div class="d-grid mb-3">
        <a href="{% url 'learning:tutor_create' %}" class="btn btn-info">
            <i class="bi bi-plus-lg me-2"></i>{% trans "New Chat" %}
        </a>
    </div>
    <div class="list-group list-group-flush overflow-auto flex-grow-1">
        {% for s in sessions %}
        <a href="{% url 'learning:tutor_session' s.id %}" class="list-group-item list-group-item-action border-0 rounded mb-1 text-truncate {% if s.id == session.id %}active bg-secondary-subtle text-light{% else %}bg-transparent text-secondary{% endif %}">
            <i class="bi bi-chat-left-text me-2"></i> {{ s.title }}
        </a>
        {% endfor %}
    </div>
  </div>
</div>


<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
<script>
    function editTitle() {
        const newTitle = prompt("{% trans 'Enter new chat title:' %}", "{{ session.title }}");
        if (newTitle) {
            // Simple approach: reload with query param or dedicated API. 
            // For now let's just use existing message API or a quick fetch if we had an endpoint.
            // Since we don't have a dedicated update title API yet, we'll skip implementation or add a TODO.
            // Actually, let's implement a simple update via API if possible, but we haven't built it.
            // fallback:
             alert("{% trans 'Renaming not implemented yet.' %}");
        }
    }

    document.addEventListener('DOMContentLoaded', function() {
        const chatMessages = document.getElementById('chat-messages');
        const chatForm = document.getElementById('chat-form');
        const messageInput = document.getElementById('message-input');
        const loading = document.getElementById('loading');
        const emptyState = document.getElementById('empty-state');
        const sessionId = "{{ session_id }}";

        chatMessages.scrollTop = chatMessages.scrollHeight;
        
        const contextTypeInput = document.getElementById('context-type');
        const contextIdInput = document.getElementById('context-id');
        const currentContextLabel = document.getElementById('current-context-label');
        const contextModal = new bootstrap.Modal(document.getElementById('contextModal'));
        const contextItems = document.querySelectorAll('.context-item');

        contextItems.forEach(item => {
            item.addEventListener('click', function() {
                const type = this.getAttribute('data-type');
                const id = this.getAttribute('data-id');
                const label = this.getAttribute('data-label');

                contextTypeInput.value = type;
                contextIdInput.value = id;
                currentContextLabel.textContent = label;

                // Highlight active item
                contextItems.forEach(i => i.classList.remove('active'));
                this.classList.add('active');

                contextModal.hide();

                fetch("{% url 'learning:tutor_context' %}", {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': '{{ csrf_token }}'
                    },
                    body: JSON.stringify({
                        session_id: sessionId,
                        context_type: type,
                        context_id: id
                    })
                }).then(response => {
                    if (!response.ok) {
                        console.error('Failed to update context');
                    }
                }).catch(error => {
                    console.error('Error updating context:', error);
                });
            });
        });

        // ... Highlight ...
        if (typeof Prism !== 'undefined') {
             Prism.highlightAll();
        }

        messageInput.addEventListener('input', function() {
            this.style.height = 'auto';
            this.style.height = (this.scrollHeight) + 'px';
            if (this.value === '') this.style.height = 'auto';
        });

        messageInput.addEventListener('keydown', function(e) {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                chatForm.dispatchEvent(new Event('submit'));
            }
        });

        chatForm.addEventListener('submit', async function(e) {
            e.preventDefault();
            const message = messageInput.value.trim();
            if (!message) return;

            // User message is plain text usually, but markdown is fine
            addMessage('user', message);
            messageInput.value = '';
            messageInput.style.height = 'auto';
            if (emptyState) emptyState.classList.add('d-none');
            loading.classList.remove('d-none');
            chatMessages.scrollTop = chatMessages.scrollHeight;

            try {
                const response = await fetch("{% url 'learning:tutor_api' %}", {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': '{{ csrf_token }}'
                    },
                    body: JSON.stringify({
                        message: message,
                        session_id: sessionId,
                        context_type: contextTypeInput.value,
                        context_id: contextIdInput.value
                    })
                });

                const data = await response.json();
                loading.classList.add('d-none');

                if (response.ok && data.status === 'success') {
                    addMessage('assistant', data.response);
                } else {
                    addMessage('error', data.error || 'An error occurred');
                }
            } catch (error) {
                loading.classList.add('d-none');
                addMessage('error', 'Network error. Please try again.');
                console.error('Error:', error);
            }
        });

        function addMessage(role, content) {
            const div = document.createElement('div');
            div.className = `d-flex mb-3 ${role === 'user' ? 'justify-content-end' : 'justify-content-start'}`;
            
            const bubbleClass = role === 'user' ? 'bg-primary text-white' : (role === 'error' ? 'bg-danger text-white' : 'bg-secondary text-light');
            const name = role === 'user' ? '{% trans "You" %}' : '{% trans "Tutor" %}';
            
            // Parse Markdown for Assistant output
            let renderedContent = content;
            if (role === 'assistant') {
                renderedContent = marked.parse(content);
            } else {
                renderedContent = escapeHtml(content).replace(/\n/g, '<br>');
            }

            div.innerHTML = `
                <div class="p-3 rounded-3 ${bubbleClass}" style="max-width: 80%;">
                    <div class="mb-1 small opacity-75">${name}</div>
                    <div class="message-content markdown-body">${renderedContent}</div>
                </div>
            `;
            chatMessages.appendChild(div);
            // Use requestAnimationFrame to ensure DOM is updated before scrolling/highlighting
            requestAnimationFrame(() => {
                chatMessages.scrollTop = chatMessages.scrollHeight;
                if (role === 'assistant' && typeof Prism !== 'undefined') {
                    Prism.highlightAllUnder(div);
                }
            });
        }
        
        function escapeHtml(text) {
             return text
                 .replace(/&/g, "&amp;")
                 .replace(/</g, "&lt;")
                 .replace(/>/g, "&gt;")
                 .replace(/"/g, "&quot;")
                 .replace(/'/g, "&#039;");
         }
    });
</script>
{% endblock %}
